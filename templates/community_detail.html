{% extends 'base.html' %}

{% block content %}
<div class="container" style="padding-top: 3rem; padding-bottom: 4rem;">
    <!-- Back Button -->
    <a href="/communities/" style="display: flex; align-items: center; color: var(--muted); text-decoration: none; margin-bottom: 2rem;">
        <i data-lucide="arrow-left" style="width: 16px; margin-right: 8px;"></i> Back to Communities
    </a>

    <!-- Community Header -->
    <div class="card" style="margin-bottom: 2rem; padding: 2rem;">
        {% if community.image %}
        <div style="margin: -2rem -2rem 1.5rem -2rem; height: 200px; overflow: hidden; border-radius: 0.5rem 0.5rem 0 0;">
            <img src="{{ community.image.url }}" alt="{{ community.name }}" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
        {% endif %}
        
        <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem;">
            {% if not community.image %}
            <div class="avatar" style="width: 5rem; height: 5rem; font-size: 2rem;">
                {{ community.name|slice:":1"|upper }}
            </div>
            {% endif %}
            <div style="flex: 1;">
                <h1 style="font-size: 2rem; font-weight: 800; color: #1f2937; margin-bottom: 0.5rem;">{{ community.name }}</h1>
                <p style="color: #6b7280;">{{ community.members.count }} members â€¢ Created by {{ community.creator.username }}</p>
            </div>
            {% if is_member %}
                <a href="/communities/{{ community.id }}/leave/" 
                   style="padding: 0.75rem 1.5rem; border: 1px solid #dc2626; color: #dc2626; border-radius: 0.5rem; text-decoration: none; font-weight: 600;">
                    Leave Community
                </a>
            {% else %}
                <a href="/communities/{{ community.id }}/join/" 
                   style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 0.5rem; text-decoration: none; font-weight: 600;">
                    Join Community
                </a>
            {% endif %}
        </div>
        
        <p style="color: #4b5563; margin-bottom: 1rem;">{{ community.description }}</p>
        
        <div style="display: flex; gap: 0.5rem;">
            <span style="padding: 0.25rem 0.75rem; background: #f3f4f6; color: #6b7280; border-radius: 1rem; font-size: 0.875rem;">
                {{ community.get_category_display }}
            </span>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div style="margin-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
        <div style="display: flex; gap: 2rem;">
            <button onclick="showTab('posts')" id="postsTab" class="tab-button active-tab" style="padding: 1rem 0.5rem; background: none; border: none; font-weight: 600; cursor: pointer; position: relative; color: #667eea; border-bottom: 3px solid #667eea;">
                <i data-lucide="message-square" style="width: 18px; display: inline; margin-right: 0.5rem;"></i>
                Posts
            </button>
            <button onclick="showTab('meetings')" id="meetingsTab" class="tab-button" style="padding: 1rem 0.5rem; background: none; border: none; font-weight: 600; cursor: pointer; position: relative; color: #6b7280; border-bottom: 3px solid transparent;">
                <i data-lucide="calendar" style="width: 18px; display: inline; margin-right: 0.5rem;"></i>
                Meetings
            </button>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
        <div style="color: {% if message.tags == 'error' %}#dc2626{% else %}#16a34a{% endif %}; padding: 0.75rem; background: {% if message.tags == 'error' %}#fee2e2{% else %}#dcfce7{% endif %}; border-radius: 0.5rem; margin-bottom: 1rem;">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <!-- Posts Tab Content -->
    <div id="postsContent" class="tab-content">

    {% if is_member %}
    <!-- Create Post Section -->
    <div class="card" style="margin-bottom: 2rem; padding: 1.5rem;">
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;">Create a Post</h2>
        <form method="POST" action="/communities/{{ community.id }}/post/" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 1rem;">
            {% csrf_token %}
            <input type="text" 
                   name="title" 
                   placeholder="Post title..." 
                   required
                   style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; font-size: 1rem;">
            <textarea name="content" 
                      rows="4" 
                      placeholder="What's on your mind?" 
                      required
                      style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; font-size: 1rem; resize: vertical;"></textarea>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: #4b5563; font-weight: 600;">Add Image (optional)</label>
                <input type="file" 
                       name="image" 
                       accept="image/*"
                       style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.5rem;">
            </div>
            <button type="submit" 
                    style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; align-self: flex-end;">
                Post
            </button>
        </form>
    </div>

    <!-- Posts Feed -->
    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Posts</h2>
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        {% for post in posts %}
        <div class="card" style="padding: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <div class="avatar" style="width: 2.5rem; height: 2.5rem; font-size: 1rem;">
                    {{ post.author.username|slice:":1"|upper }}
                </div>
                <div>
                    <h3 style="font-weight: 600; color: #1f2937;">{{ post.author.username }}</h3>
                    <p style="font-size: 0.875rem; color: #6b7280;">{{ post.created_at|timesince }} ago</p>
                </div>
            </div>
            
            <h3 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">{{ post.title }}</h3>
            <p style="color: #4b5563; margin-bottom: 1rem; white-space: pre-wrap;">{{ post.content }}</p>
            
            {% if post.image %}
            <div style="margin-bottom: 1rem;">
                <img src="{{ post.image.url }}" alt="{{ post.title }}" style="max-width: 100%; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            </div>
            {% endif %}
            
            <div style="display: flex; gap: 1rem; align-items: center;">
                <a href="/posts/{{ post.id }}/upvote/" 
                   style="display: flex; align-items: center; gap: 0.25rem; color: #667eea; text-decoration: none; font-weight: 600;">
                    <i data-lucide="arrow-up" style="width: 18px;"></i>
                    {{ post.upvotes }}
                </a>
                <a href="/posts/{{ post.id }}/downvote/" 
                   style="display: flex; align-items: center; gap: 0.25rem; color: #6b7280; text-decoration: none; font-weight: 600;">
                    <i data-lucide="arrow-down" style="width: 18px;"></i>
                    {{ post.downvotes }}
                </a>
                <a href="/posts/{{ post.id }}/" 
                   style="display: flex; align-items: center; gap: 0.25rem; color: #6b7280; text-decoration: none; font-weight: 600;">
                    <i data-lucide="message-square" style="width: 18px;"></i>
                    Comments
                </a>
            </div>
        </div>
        {% empty %}
        <div class="card" style="padding: 3rem; text-align: center;">
            <i data-lucide="message-square" style="width: 3rem; height: 3rem; margin: 0 auto 1rem; opacity: 0.5; color: #6b7280;"></i>
            <p style="color: #6b7280;">No posts yet. Be the first to post!</p>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card" style="padding: 3rem; text-align: center;">
        <i data-lucide="lock" style="width: 3rem; height: 3rem; margin: 0 auto 1rem; opacity: 0.5; color: #6b7280;"></i>
        <h3 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">Join to View Posts</h3>
        <p style="color: #6b7280; margin-bottom: 1.5rem;">You need to be a member to see posts and participate.</p>
        <a href="/communities/{{ community.id }}/join/" 
           style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 0.5rem; text-decoration: none; font-weight: 600; display: inline-block;">
            Join Community
        </a>
    </div>
    {% endif %}
    </div>

    <!-- Meetings Tab Content -->
    <div id="meetingsContent" class="tab-content" style="display: none;">
        {% if is_member %}
        <!-- Create Meeting Section - Simple Form Like Posts -->
        <div class="card" style="margin-bottom: 2rem; padding: 1.5rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;">Schedule Community Meeting</h2>
            <form method="POST" action="/communities/{{ community.id }}/meeting/" style="display: flex; flex-direction: column; gap: 1rem;">
                {% csrf_token %}
                <input type="text" 
                       name="title" 
                       placeholder="Meeting title..." 
                       required
                       style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; font-size: 1rem;">
                
                <textarea name="description" 
                          rows="3" 
                          placeholder="What will be discussed?" 
                          style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; font-size: 1rem; resize: vertical;"></textarea>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #4b5563; font-weight: 600;">Date *</label>
                        <input type="date" 
                               name="date" 
                               required
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #4b5563; font-weight: 600;">Time *</label>
                        <input type="time" 
                               name="time" 
                               required
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #4b5563; font-weight: 600;">Duration (minutes)</label>
                        <input type="number" 
                               name="duration" 
                               value="60" 
                               min="15" 
                               step="15"
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #4b5563; font-weight: 600;">Zoom/Meet Link (optional)</label>
                        <input type="url" 
                               name="zoom_link" 
                               placeholder="https://zoom.us/..."
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem;">
                    </div>
                </div>
                
                <button type="submit" 
                        style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; align-self: flex-end;">
                    Schedule Meeting
                </button>
            </form>
        </div>

        <!-- Meetings List -->
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Upcoming Meetings</h2>
        
        {% if community.meetings.all %}
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem;">
            {% for meeting in community.meetings.all %}
            <div class="card" style="padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div>
                        <h3 style="font-weight: 700; font-size: 1.1rem; color: #1f2937;">{{ meeting.title }}</h3>
                        <p style="font-size: 0.85rem; color: #667eea; margin-top: 0.25rem;">
                            Hosted by {{ meeting.mentor.first_name|default:meeting.mentor.username }}
                        </p>
                    </div>
                    <span style="font-size: 0.75rem; padding: 0.375rem 0.75rem; 
                        {% if meeting.status == 'completed' %}background: rgba(34, 197, 94, 0.1); color: #22c55e;
                        {% elif meeting.status == 'cancelled' %}background: rgba(239, 68, 68, 0.1); color: #ef4444;
                        {% elif meeting.status == 'ongoing' %}background: rgba(59, 130, 246, 0.1); color: #3b82f6;
                        {% else %}background: rgba(249, 115, 22, 0.1); color: #f97316;{% endif %}
                        border-radius: 99px; font-weight: 600; text-transform: capitalize;">
                        {{ meeting.status }}
                    </span>
                </div>
                
                {% if meeting.description %}
                <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">{{ meeting.description }}</p>
                {% endif %}
                
                <div style="display: flex; gap: 1.5rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #6b7280;">
                        <i data-lucide="calendar" style="width: 16px; color: #667eea;"></i> 
                        {{ meeting.scheduled_time|date:"M d, Y" }}
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #6b7280;">
                        <i data-lucide="clock" style="width: 16px; color: #667eea;"></i> 
                        {{ meeting.scheduled_time|time:"g:i A" }}
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #6b7280;">
                        <i data-lucide="users" style="width: 16px; color: #667eea;"></i> 
                        {{ meeting.attendees.count }}
                    </div>
                </div>

                {% if meeting.zoom_link %}
                <a href="{{ meeting.zoom_link }}" target="_blank" 
                   style="display: inline-block; padding: 0.65rem 1.25rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 0.5rem; text-decoration: none; font-weight: 600; font-size: 0.85rem;">
                    <i data-lucide="video" style="width: 14px; display: inline; margin-right: 0.5rem;"></i>
                    Join Meeting
                </a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="card" style="padding: 3rem; text-align: center; color: #6b7280;">
            <i data-lucide="calendar" style="width: 3rem; height: 3rem; margin: 0 auto 1rem; opacity: 0.5;"></i>
            <p style="font-weight: 600; margin-bottom: 0.5rem;">No meetings scheduled yet</p>
            <p style="font-size: 0.9rem;">Be the first to schedule a community meeting above!</p>
        </div>
        {% endif %}
        
        {% else %}
        <div class="card" style="padding: 3rem; text-align: center;">
            <i data-lucide="lock" style="width: 3rem; height: 3rem; margin: 0 auto 1rem; opacity: 0.5; color: #6b7280;"></i>
            <h3 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">Join to View Meetings</h3>
            <p style="color: #6b7280; margin-bottom: 1.5rem;">You need to be a member to see and schedule meetings.</p>
            <a href="/communities/{{ community.id }}/join/" 
               style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 0.5rem; text-decoration: none; font-weight: 600; display: inline-block;">
                Join Community
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Tab switching
    function showTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.style.color = '#6b7280';
            button.style.borderBottom = '3px solid transparent';
            button.classList.remove('active-tab');
        });
        
        // Show selected tab content
        if (tabName === 'posts') {
            document.getElementById('postsContent').style.display = 'block';
            document.getElementById('postsTab').style.color = '#667eea';
            document.getElementById('postsTab').style.borderBottom = '3px solid #667eea';
            document.getElementById('postsTab').classList.add('active-tab');
        } else if (tabName === 'meetings') {
            document.getElementById('meetingsContent').style.display = 'block';
            document.getElementById('meetingsTab').style.color = '#667eea';
            document.getElementById('meetingsTab').style.borderBottom = '3px solid #667eea';
            document.getElementById('meetingsTab').classList.add('active-tab');
        }
    }
    
    lucide.createIcons();
</script>
{% endblock %}
