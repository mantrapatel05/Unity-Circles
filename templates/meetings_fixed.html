{% extends 'base.html' %}

{% block content %}
<div class="container" style="padding-top: 3rem; padding-bottom: 4rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem;">
        <div>
            <h1 style="font-size: 2.75rem; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Community Meetings</h1>
            <p style="color: #6b7280; margin-top: 0.5rem;">Schedule and manage your mentorship sessions</p>
        </div>
        <button id="scheduleMeetingBtn" class="btn btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 0.75rem; padding: 0.875rem 1.75rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; text-decoration: none; cursor: pointer; border: none;">
            <i data-lucide="plus" style="width: 20px;"></i> Schedule Meeting
        </button>
    </div>

    <div id="errorMessage" style="display: none; color: #dc2626; padding: 1rem; background: #fee2e2; border-radius: 0.5rem; margin-bottom: 1.5rem;"></div>
    <div id="successMessage" style="display: none; color: #16a34a; padding: 1rem; background: #dcfce7; border-radius: 0.5rem; margin-bottom: 1.5rem;"></div>

    <div id="meetingsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem;">
        <div class="card" style="padding: 2rem; text-align: center; color: #6b7280;">
            <i data-lucide="calendar" style="width: 3rem; height: 3rem; margin: 0 auto 1rem; opacity: 0.5;"></i>
            <p>Loading meetings...</p>
        </div>
    </div>
</div>

<!-- Schedule Meeting Modal -->
<div id="scheduleMeetingModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 600px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.2); margin: 2rem 0;">
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; color: #1f2937;">Schedule a Meeting</h2>
        
        <form id="meetingForm">
            {% csrf_token %}
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 600;">Meeting Title *</label>
                <input type="text" id="meetingTitle" name="title" required style="width: 100%; padding: 0.875rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; font-family: 'Quicksand', sans-serif; font-size: 1rem;" placeholder="e.g., Career Discussion">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 600;">Description</label>
                <textarea id="meetingDesc" name="description" style="width: 100%; padding: 0.875rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; font-family: 'Quicksand', sans-serif; font-size: 1rem;" placeholder="What will you discuss?" rows="3"></textarea>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 600;">Date *</label>
                    <input type="date" id="meetingDate" name="date" required style="width: 100%; padding: 0.875rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; font-family: 'Quicksand', sans-serif; font-size: 1rem;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 600;">Time *</label>
                    <input type="time" id="meetingTime" name="time" required style="width: 100%; padding: 0.875rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; font-family: 'Quicksand', sans-serif; font-size: 1rem;">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 600;">Duration (minutes)</label>
                    <input type="number" id="meetingDuration" name="duration" value="60" min="15" step="15" style="width: 100%; padding: 0.875rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; font-family: 'Quicksand', sans-serif; font-size: 1rem;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #374151; font-weight: 600;">Meeting Link (optional)</label>
                    <input type="url" id="meetingLink" name="link" style="width: 100%; padding: 0.875rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; font-family: 'Quicksand', sans-serif; font-size: 1rem;" placeholder="https://zoom.us/...">
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="button" id="cancelMeeting" style="flex: 1; padding: 0.875rem; border: 1px solid #e5e7eb; background: white; color: #6b7280; font-weight: 600; border-radius: 0.5rem; cursor: pointer;">Cancel</button>
                <button type="submit" id="createMeetingBtn" style="flex: 1; padding: 0.875rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; border: none; border-radius: 0.5rem; cursor: pointer;">Create Meeting</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        setTimeout(() => { successDiv.style.display = 'none'; }, 3000);
    }

    // Load meetings
    async function loadMeetings() {
        try {
            const response = await fetch('/api/meetings/', {
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrftoken,
                }
            });
            
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Please log in to view meetings');
                }
                throw new Error(`Error loading meetings (${response.status})`);
            }
            
            const meetings = await response.json();
            const meetingsList = document.getElementById('meetingsList');
            
            if (!meetings || meetings.length === 0) {
                meetingsList.innerHTML = `
                    <div class="card" style="padding: 2rem; text-align: center; color: #6b7280; grid-column: 1/-1;">
                        <i data-lucide="calendar" style="width: 3rem; height: 3rem; margin: 0 auto 1rem; opacity: 0.5;"></i>
                        <p style="font-weight: 600; margin-bottom: 0.5rem;">No meetings scheduled yet</p>
                        <p style="font-size: 0.9rem;">Click "Schedule Meeting" above to create your first meeting</p>
                    </div>
                `;
            } else {
                meetingsList.innerHTML = meetings.map(meeting => `
                    <div class="card" style="transition: all 0.3s; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 30px rgba(102, 126, 234, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;">
                            <div>
                                <h3 style="font-weight: 700; font-size: 1.25rem; color: #1f2937;">${meeting.title}</h3>
                                <p style="font-size: 0.9rem; color: #667eea; margin-top: 0.25rem;">
                                    Hosted by ${meeting.mentor?.first_name || meeting.mentor?.username || 'Unknown'}
                                </p>
                            </div>
                            <span style="font-size: 0.75rem; padding: 0.375rem 0.875rem; ${getStatusStyle(meeting.status)}border-radius: 99px; font-weight: 600; text-transform: capitalize;">
                                ${meeting.status || 'scheduled'}
                            </span>
                        </div>
                        
                        <p style="color: #6b7280; font-size: 0.95rem; margin-bottom: 1rem;">${meeting.description || 'No description provided'}</p>
                        
                        <div style="display: flex; gap: 2rem; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e5e7eb; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #6b7280;">
                                <i data-lucide="calendar" style="width: 18px; color: #667eea;"></i> 
                                ${new Date(meeting.scheduled_time).toLocaleDateString()}
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #6b7280;">
                                <i data-lucide="clock" style="width: 18px; color: #667eea;"></i> 
                                ${new Date(meeting.scheduled_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #6b7280;">
                                <i data-lucide="users" style="width: 18px; color: #667eea;"></i> 
                                ${meeting.attendees_count || 0} attending
                            </div>
                        </div>

                        ${meeting.zoom_link ? `
                            <a href="${meeting.zoom_link}" target="_blank" style="display: inline-block; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 0.5rem; text-decoration: none; font-weight: 600; font-size: 0.9rem; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 15px rgba(102, 126, 234, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <i data-lucide="video" style="width: 16px; display: inline; margin-right: 0.5rem;"></i>
                                Join Meeting
                            </a>
                        ` : ''}
                    </div>
                `).join('');
            }
            
            lucide.createIcons();
        } catch (error) {
            console.error('Error loading meetings:', error);
            const meetingsList = document.getElementById('meetingsList');
            meetingsList.innerHTML = `
                <div class="card" style="padding: 2rem; text-align: center; color: #dc2626; grid-column: 1/-1;">
                    <i data-lucide="alert-circle" style="width: 3rem; height: 3rem; margin: 0 auto 1rem; opacity: 0.5;"></i>
                    <p style="font-weight: 600; margin-bottom: 0.5rem;">Error loading meetings</p>
                    <p style="font-size: 0.9rem;">${error.message}</p>
                    <button onclick="loadMeetings()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                        Try Again
                    </button>
                </div>
            `;
            lucide.createIcons();
        }
    }

    function getStatusStyle(status) {
        switch(status) {
            case 'completed': return 'background: rgba(34, 197, 94, 0.1); color: #22c55e; ';
            case 'cancelled': return 'background: rgba(239, 68, 68, 0.1); color: #ef4444; ';
            case 'ongoing': return 'background: rgba(59, 130, 246, 0.1); color: #3b82f6; ';
            default: return 'background: rgba(249, 115, 22, 0.1); color: #f97316; ';
        }
    }

    // Modal controls
    document.getElementById('scheduleMeetingBtn').addEventListener('click', () => {
        document.getElementById('scheduleMeetingModal').style.display = 'flex';
    });

    document.getElementById('cancelMeeting').addEventListener('click', () => {
        document.getElementById('scheduleMeetingModal').style.display = 'none';
        document.getElementById('meetingForm').reset();
    });

    // Form submission
    document.getElementById('meetingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const date = formData.get('date');
        const time = formData.get('time');
        
        const scheduledTime = new Date(`${date}T${time}`).toISOString();
        
        const data = {
            title: formData.get('title'),
            description: formData.get('description'),
            scheduled_time: scheduledTime,
            duration_minutes: parseInt(formData.get('duration')),
            zoom_link: formData.get('link') || null,
        };
        
        try {
            const response = await fetch('/api/meetings/', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to create meeting');
            }
            
            document.getElementById('scheduleMeetingModal').style.display = 'none';
            document.getElementById('meetingForm').reset();
            showSuccess('Meeting created successfully!');
            loadMeetings();
        } catch (error) {
            console.error('Error creating meeting:', error);
            showError(error.message);
        }
    });

    // Auto-refresh every 30 seconds
    let refreshInterval;
    function startAutoRefresh() {
        refreshInterval = setInterval(loadMeetings, 30000);
    }

    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            clearInterval(refreshInterval);
        } else {
            loadMeetings();
            startAutoRefresh();
        }
    });

    // Initial load
    loadMeetings();
    startAutoRefresh();
    lucide.createIcons();
</script>

{% endblock %}
