{% extends "base.html" %}
{% block content %}

<style>
.messages-container {
    padding-top: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.messages-grid {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 1rem;
    height: calc(100vh - 150px);
}

.users-list {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    overflow-y: auto;
}

.users-list h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.2rem;
}

.user-item {
    display: block;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: white;
    border-radius: 6px;
    text-decoration: none;
    color: #333;
    transition: all 0.2s;
}

.user-item:hover {
    background: #e9ecef;
    transform: translateX(5px);
}

.user-item.active {
    background: #007bff;
    color: white;
}

.chat-area {
    background: white;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.chat-header {
    padding: 1rem;
    border-bottom: 2px solid #e9ecef;
    font-size: 1.2rem;
    font-weight: 600;
}

.messages-area {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
}

.message {
    margin-bottom: 1rem;
    display: flex;
    flex-direction: column;
}

.message.sent {
    align-items: flex-end;
}

.message.received {
    align-items: flex-start;
}

.message-content {
    max-width: 70%;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    word-wrap: break-word;
}

.message.sent .message-content {
    background: #007bff;
    color: white;
}

.message.received .message-content {
    background: white;
    border: 1px solid #dee2e6;
}

.message-sender {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    padding: 0 0.5rem;
}

.no-messages {
    text-align: center;
    color: #6c757d;
    margin-top: 2rem;
}

.message-form {
    padding: 1rem;
    border-top: 2px solid #e9ecef;
    display: flex;
    gap: 0.5rem;
}

.message-input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-size: 1rem;
}

.send-button {
    padding: 0.75rem 1.5rem;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
}

.send-button:hover {
    background: #0056b3;
}

.empty-state {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #6c757d;
    font-size: 1.1rem;
}

.auto-refresh-indicator {
    font-size: 0.85rem;
    color: #6c757d;
    text-align: center;
    padding: 0.5rem;
}
</style>

<div class="messages-container">
    <h1 style="margin-bottom: 1.5rem;">Messages</h1>
    
    <div class="messages-grid">
        <!-- Users List -->
        <div class="users-list">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="margin: 0;">Conversations</h3>
                <button onclick="showNewChatModal()" style="padding: 0.5rem 1rem; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">+ New</button>
            </div>
            {% for u in mentors %}
                <a href="/chat/?to={{ u.id }}" 
                   class="user-item {% if chat_user and chat_user.id == u.id %}active{% endif %}">
                    {{ u.username }}
                    {% if u.first_name or u.last_name %}
                        <br><small>{{ u.first_name }} {{ u.last_name }}</small>
                    {% endif %}
                </a>
            {% empty %}
                <p style="text-align:center;color:#6c757d;">No conversations yet</p>
                <p style="text-align:center;color:#6c757d;font-size:0.9rem;">Click "New" to start a chat</p>
            {% endfor %}
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            {% if chat_user %}
                <div class="chat-header">
                    Chat with {{ chat_user.username }}
                    {% if chat_user.first_name or chat_user.last_name %}
                        ({{ chat_user.first_name }} {{ chat_user.last_name }})
                    {% endif %}
                </div>

                <div class="messages-area" id="messagesArea">
                    {% for m in messages %}
                        <div class="message {% if m.sender == request.user %}sent{% else %}received{% endif %}">
                            <div class="message-sender">{{ m.sender.username }}</div>
                            <div class="message-content">{{ m.content }}</div>
                        </div>
                    {% empty %}
                        <div class="no-messages">
                            No messages yet. Start the conversation!
                        </div>
                    {% endfor %}
                </div>

                <form method="post" action="/chat/send/" class="message-form" onsubmit="return handleSend(event)">
                    {% csrf_token %}
                    <input type="hidden" name="receiver" value="{{ chat_user.id }}">
                    <input 
                        name="content" 
                        required 
                        class="message-input" 
                        placeholder="Type your message..."
                        id="messageInput"
                        autocomplete="off">
                    <button type="submit" class="send-button">Send</button>
                </form>

                <div class="auto-refresh-indicator">
                    Messages refresh automatically every 60 seconds
                </div>
            {% else %}
                <div class="empty-state">
                    Select a user to start chatting
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- New Chat Modal -->
<div id="newChatModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 8px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0;">Start New Chat</h2>
            <button onclick="closeNewChatModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;">&times;</button>
        </div>
        <div id="allUsersList" style="display: flex; flex-direction: column; gap: 0.5rem;">
            Loading users...
        </div>
    </div>
</div>

<script>
    // Auto-scroll to bottom of messages
    function scrollToBottom() {
        const messagesArea = document.getElementById('messagesArea');
        if (messagesArea) {
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }
    }

    // Scroll to bottom on page load
    scrollToBottom();

    // Auto-refresh messages every 60 seconds
    {% if chat_user %}
    setInterval(function() {
        // Reload the page to get new messages
        location.reload();
    }, 60000); // 60000 milliseconds = 60 seconds
    {% endif %}

    // Handle form submission
    function handleSend(event) {
        const input = document.getElementById('messageInput');
        if (!input.value.trim()) {
            event.preventDefault();
            return false;
        }
        return true;
    }

    // New chat modal functions
    async function showNewChatModal() {
        document.getElementById('newChatModal').style.display = 'flex';
        // Load all users
        try {
            const response = await fetch('/chat/api/all-users/');
            const users = await response.json();
            const usersList = document.getElementById('allUsersList');
            
            if (users.length === 0) {
                usersList.innerHTML = '<p style="text-align:center;color:#6c757d;">No users available</p>';
            } else {
                usersList.innerHTML = users.map(user => `
                    <a href="/chat/?to=${user.id}" style="display: block; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; text-decoration: none; color: #333; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                        <div style="font-weight: 600;">${user.username}</div>
                        ${user.first_name || user.last_name ? `<div style="font-size: 0.85rem; color: #6c757d;">${user.first_name || ''} ${user.last_name || ''}</div>` : ''}
                    </a>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading users:', error);
            document.getElementById('allUsersList').innerHTML = '<p style="text-align:center;color:#dc3545;">Error loading users</p>';
        }
    }

    function closeNewChatModal() {
        document.getElementById('newChatModal').style.display = 'none';
    }

    // Close modal when clicking outside
    document.getElementById('newChatModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeNewChatModal();
        }
    });
</script>

{% endblock %}
